# Audit: Bundle Creation and Update APIs (`greentic-operator`)

## Canonical lifecycle to reuse

This repo already has a canonical demo bundle update path in `src/cli.rs` through `DemoPolicyArgs::run`:

1. Write gmap rule via `gmap::upsert_policy(...)`.
2. Rerun resolver via `project::sync_project(...)`.
3. Copy resolver output to demo-visible manifest via `copy_resolved_manifest(...)`.

References:
- `src/cli.rs:2694`
- `src/cli.rs:2712`
- `src/cli.rs:2713`
- `src/cli.rs:2714`

This is the authoritative allow/update behavior and is the required integration target for wizard execution.

## Bundle creation APIs in this repo

There are two existing creation paths:

1. Demo scaffold creator (`demo new`)
- `create_demo_bundle_structure(...)` in `src/cli.rs`.
- Creates expected demo directories and `greentic.demo.yaml`.
- Initializes default gmap files.

Reference:
- `src/cli.rs:3576`

2. Demo bundle builder (`demo build`)
- `demo::build_bundle(...)` in `src/demo/build.rs`.
- Copies providers/packs/tenants and writes `resolved/*.yaml` and metadata.

Reference:
- `src/demo/build.rs:28`

For wizard create MVP, scaffold + resolver path is sufficient and aligns with existing operator semantics.

## Resolver and state representation

Resolver pipeline entrypoint:
- `project::sync_project(...)` -> `project::resolve::resolve(...)`.

Resolved artifacts:
- `state/resolved/<tenant>[.<team>].yaml` generated by resolver.
- `resolved/<tenant>[.<team>].yaml` copied for demo start visibility.

References:
- `src/project/mod.rs:17`
- `src/project/resolve.rs:40`
- `src/cli.rs:4025`

## Allow model (authoritative)

Allow is implemented through gmap rules.

Paths and files:
- tenant-level: `tenants/<tenant>/tenant.gmap`
- team-level: `tenants/<tenant>/teams/<team>/team.gmap`

Rule syntax:
- `PACK[/FLOW[/NODE]]` (up to 3 segments)

References:
- `src/cli.rs:825`
- `src/cli.rs:4015`

## Pack resolution source

Wizard pack refs are resolved via `greentic-distributor-client` (`pack-fetch` API).

Current integration in wizard module:
- `OciPackFetcher::fetch_pack_to_cache(...)`
- Supports `oci://` directly and `repo://`/`store://` via env-based mapping:
  - `GREENTIC_REPO_REGISTRY_BASE`
  - `GREENTIC_STORE_REGISTRY_BASE`

Reference:
- `src/wizard.rs`

## Validation strategy

Strongest available path in-repo for wizard MVP is resolver-visible correctness:

1. run resolver (`project::sync_project`)
2. ensure `state/resolved/...` exists
3. copy to `resolved/...`
4. ensure copied manifest exists

Doctor can be layered later when command wiring for pack doctor is required in wizard.

## Setup execution reuse

Wizard setup execution reuses existing CLI setup pipeline instead of custom logic:

- `run_domain_command(...)` with `DomainAction::Setup` for each domain.
- setup runs are constrained via `allowed_providers` derived from selected wizard packs.
- setup answers are collected pack-by-pack via existing `collect_setup_answers(...)` and injected as `preloaded_setup_answers`.
- This preserves existing QA/apply-answers and provider setup flow behavior.

References:
- `src/cli.rs` (`run_domain_command` and domain setup flow)
